version: "3.5"
services:
#  praefect:
#    build:
#      context: ../../
#      dockerfile: Dockerfile.praefect
#    image: praefect:latest
#    depends_on:
#      - gitaly-1
#      - gitaly-2
#      - gitaly-3
#    command: ["/etc/gitaly/praefect", "-config", "/etc/gitaly/config.praefect.toml"]
#    ports:
#      - "2305:2305"
#    volumes:
#      - ./config.praefect.toml:/etc/gitaly/config.praefect.toml
  gitaly-1:
    image: registry.gitlab.com/gitlab-org/build/cng/gitaly:latest
    environment:
      - GITALY_TESTING_NO_GIT_HOOKS=1
    expose:
      - "9999"
    ports:
      - "9999:9999"
    command: ["/usr/local/bin/gitaly", "/etc/config/config.toml"]
    volumes:
      - ./gitaly-1/data:/home/git/repositories
      - ./config.gitaly.toml:/etc/config/config.toml
  gitaly-2:
    image: registry.gitlab.com/gitlab-org/build/cng/gitaly:latest
    environment:
      - GITALY_TESTING_NO_GIT_HOOKS=1
    expose:
      - "9999"
    ports:
      - "9998:9999"
    command: ["/usr/local/bin/gitaly", "/etc/config/config.toml"]
    volumes:
      - ./gitaly-2/data:/home/git/repositories
      - ./config.gitaly.toml:/etc/config/config.toml
  gitaly-3:
    image: registry.gitlab.com/gitlab-org/build/cng/gitaly:latest
    environment:
      - GITALY_TESTING_NO_GIT_HOOKS=1
    expose:
      - "9999"
    ports:
      - "9997:9999"
    command: ["/usr/local/bin/gitaly", "/etc/config/config.toml"]
    volumes:
      - ./gitaly-3/data:/home/git/repositories
      - ./config.gitaly.toml:/etc/config/config.toml